# Technical Specification: SuperSaas

Данный документ описывает технические требования, стек технологий и архитектуру проекта SuperSaas - полноценного SaaS-решения с интегрированным лендингом.

## 1. Цели проекта

- Разработать высокопроизводительную SaaS-платформу с интегрированным лендингом
- Предоставить пользователям полный цикл функционала: от регистрации до подписок и работы в приложении
- Обеспечить многоязычность и SEO-оптимизацию для лендинга и публичных страниц
- Реализовать безопасную систему аутентификации и авторизации через Auth0
- Внедрить систему подписок и биллинга через Stripe
- Спроектировать масштабируемую архитектуру, готовую к росту пользовательской базы

## 2. Технологический стек

- **Фреймворк:** [Next.js](https://nextjs.org/) (v14+ с App Router) - Fast by default, с оптимизированной конфигурацией для производительности
- **Язык:** [TypeScript](https://www.typescriptlang.org/) - Статический типизатор для end-to-end типобезопасности
- **Аутентификация:** [NextAuth.js](https://next-auth.js.org/) с Auth0 провайдером - Аутентификация для Next.js
- **База данных:** 
  - [PostgreSQL](https://www.postgresql.org/) - Самая продвинутая открытая СУБД
  - [Prisma](https://www.prisma.io/) - ORM нового поколения для Node.js и TypeScript (для управления схемой)
  - [Kysely](https://kysely.dev/) - Типобезопасный SQL-конструктор для TypeScript (для запросов)
  - [Drizzle](https://orm.drizzle.team/) - Современная, легковесная ORM (скоро будет добавлена)
- **Стейт-менеджмент:** [Zustand](https://zustand-demo.pmnd.rs/) - Маленький, быстрый и масштабируемый менеджер состояний для React
- **UI-библиотека:** 
  - [shadcn/ui](https://ui.shadcn.com/) - Переиспользуемые компоненты на основе Radix UI и Tailwind CSS
  - [tamagui](https://tamagui.dev/) - Коллекция доступных, переиспользуемых компонентов для React (в платном плане)
- **Стилизация:** [Tailwind CSS](https://tailwindcss.com/) v4.x - Utility-first CSS фреймворк для быстрой разработки UI
  - Используется новый пакет `@tailwindcss/postcss` вместо прямого плагина `tailwindcss`
  - В postcss.config.mjs должен использоваться формат `'@tailwindcss/postcss': {}`
  - Для CSS-переменных в tailwind.config.mjs использовать прямые ссылки на переменные CSS (var(--color))
  - Избегать использования директивы @apply с border-border и другими устаревшими классами
- **Платежи:** 
  - [Stripe](https://stripe.com/) - Платежная система для интернет-бизнеса
  - [Lemonsqueezy](https://lemonsqueezy.com/) - Платежи, налоги и подписки для программных компаний (в платном плане)
- **Email:** 
  - [React-email](https://react.email/) - React-рендерер для создания красивых писем
  - [Resend](https://resend.com/) - Платформа для email-маркетинга для разработчиков
- **API:** [tRPC](https://trpc.io/) - End-to-end типобезопасные API endpoints
- **Управление окружением:** [T3 Env](https://env.t3.gg/) - Управление переменными окружения
- **Data-fetching:** [TanStack Query](https://tanstack.com/query) - Инструменты для управления состоянием, роутинга, визуализации данных
- **Анимации:** [Framer Motion](https://www.framer.com/motion/) - Библиотека анимаций для React
- **Иконки:** [Lucide](https://lucide.dev/) - Красивые, простые, пиксельно-совершенные иконки
- **Шрифты:** [next/font](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) - Оптимизация шрифтов без внешних запросов
- **Интернационализация:** [next-intl](https://next-intl-docs.vercel.app/) - Поддержка интернационализации
- **Менеджер пакетов:** [bun](https://bun.sh/) - Альтернатива npm для более быстрого и надежного управления пакетами
- **Монорепозиторий:** Структура на основе [Turborepo](https://turbo.build/repo) - Монорепозиторий для лучшего управления кодом
- **Линтинг/Форматирование:** 
  - [ESLint](https://eslint.org/) - Плагин для проверки кода Next.js и TypeScript
  - [Prettier](https://prettier.io/) - Форматирование кода для единого стиля
  - [Husky](https://typicode.github.io/husky/) - Git hooks для автоматизации процессов
  - [Biome](https://biomejs.dev/) - Единый инструментарий для веб-проектов (в платном плане)
- **Аналитика и производительность:** 
  - [Google Analytics 4](https://analytics.google.com/) - Аналитика от Google
  - [Posthog](https://posthog.com/) - Продуктовая аналитика для разработчиков
  - [Vercel Analytics](https://vercel.com/analytics) - Метрики производительности для Next.js в реальном времени
  - [million.js](https://million.dev/) - Ускорение React на 70%
- **Работа с валютами:** [dinero.js](https://dinerojs.com/) - Библиотека для работы с денежными значениями
- **Отслеживание ошибок:** [Sentry](https://sentry.io/) - Мониторинг ошибок и производительности
- **CDN и инфраструктура:** 
  - [Cloudflare](https://www.cloudflare.com/) - Веб-производительность и безопасность

## 2.1. Философия и подход к разработке

При создании SuperSaas мы руководствуемся следующими принципами:

1. **Готовность к реальному применению** - Наша цель - предоставить стартовый набор, готовый к производственному использованию, с надежной основой для разработки полноценных приложений.

2. **Улучшенный опыт разработки** - Мы стремимся создать стартер, который не только улучшает опыт разработчика, но и повышает продуктивность.

3. **Оптимизация кодовой базы** - Мы оптимизируем кодовую базу и минимизируем зависимости, обеспечивая легковесный и эффективный процесс разработки.

4. **Тщательный выбор библиотек** - Мы тщательно отбираем только те сторонние библиотеки, которые постоянно поддерживаются и заслуживают доверия, обеспечивая проектам стабильную и надежную основу.


## 2.4. Особенности производительности

Проект SuperSaas разработан с учетом максимальной производительности:

- **Core Web Vitals** - Оптимизация для поддержания метрик Core Web Vitals в "зеленой зоне"
- **Оптимизация бандлов** - Использование современных подходов для минимизации размера JavaScript-бандлов
- **Инкрементальная статическая регенерация (ISR)** - Для оптимального баланса между динамическим и статическим контентом
- **Серверные компоненты** - Максимальное использование Server Components для уменьшения клиентского JavaScript
- **Эффективное кэширование** - Стратегии кэширования на всех уровнях для минимизации сетевых запросов
- **Ленивая загрузка** - Отложенная загрузка компонентов и ресурсов, не критичных для начального рендеринга
- **Оптимизация изображений** - Автоматическая оптимизация и обработка изображений с помощью next/image
- **Предварительная загрузка и предварительный рендеринг** - Использование prefetch и preload для критичных ресурсов

## 3. Архитектура и ключевые концепции

- **Хостинг:**
    - **Frontend (Next.js):** Vercel для оптимальной производительности и интеграции с Next.js
    - **База данных:** PostgreSQL (managed service на выбранном облачном провайдере)
    
- **Монорепозиторий:**
    - Разделение на пакеты: UI-компоненты, общие утилиты, API, модели базы данных
    - Каждый пакет имеет собственный package.json и сборку
    - Модульная структура позволяет переиспользовать код между различными частями приложения

- **Аутентификация:**
    - NextAuth.js с Auth0 провайдером для OAuth
    - Поддержка email-аутентификации
    - JWT для хранения сессий
    - Защищенные роуты для авторизованных пользователей

- **База данных:**
    - PostgreSQL в качестве основной БД
    - Prisma для определения и управления схемой (миграции)
    - Kysely для типобезопасных SQL-запросов
    - Модели данных для пользователей, подписок, платежей и контента

- **API-архитектура:**
    - tRPC для типобезопасных API endpoints
    - Разделение на роутеры по доменным областям
    - Middleware для авторизации, валидации и логирования
    - Интеграция с TanStack Query для кэширования и синхронизации состояния

- **Многоязычность:**
    - `next-intl` для управления интернационализацией
    - Локализованные роуты (e.g., `/en/dashboard`, `/ru/dashboard`)
    - Статические UI-переводы в JSON файлах
    - Динамический контент с поддержкой перевода

- **Подписки и биллинг:**
    - Интеграция со Stripe для управления подписками
    - Хуки для обработки событий Stripe (обновление подписки, истечение срока и т.д.)
    - Панель управления подписками для пользователей
    - Разные уровни доступа в зависимости от плана подписки

- **Email-коммуникации:**
    - React-email для создания красивых шаблонов писем
    - Отправка через Resend
    - Триггеры для верификации, уведомлений, маркетинговых рассылок
    - Настройка email-предпочтений пользователями

- **SEO:**
    - Метаданные для каждой страницы
    - Генерация sitemap.xml
    - OpenGraph и Twitter карточки
    - Структурированные данные (JSON-LD)
    - Оптимизация загрузки и производительности

## 4. Структура проекта (монорепозиторий)

```
SuperSaas/                    # Корневая директория проекта
├── .github/                  # GitHub Actions и конфигурации
├── apps/                     # Приложения
│   ├── docs/                 # Документация
│   │   └── ...
│   ├── nextjs/               # Основное Next.js приложение
│   │   ├── public/           # Статические файлы
│   │   ├── src/
│   │   │   ├── app/          # App Router
│   │   │   │   ├── [locale]/ # Локализованные роуты
│   │   │   │   │   ├── (auth)/    # Группа для аутентификации
│   │   │   │   │   │   ├── login/
│   │   │   │   │   │   ├── register/
│   │   │   │   │   │   └── ...
│   │   │   │   │   ├── (dashboard)/ # Группа для авторизованных пользователей
│   │   │   │   │   │   ├── dashboard/
│   │   │   │   │   │   ├── settings/
│   │   │   │   │   │   └── ...
│   │   │   │   │   ├── (marketing)/ # Группа для маркетинговых страниц
│   │   │   │   │   │   ├── about/
│   │   │   │   │   │   ├── pricing/
│   │   │   │   │   │   └── ...
│   │   │   │   │   ├── api/        # API роуты
│   │   │   │   │   │   └── ...
│   │   │   │   │   ├── globals.css # Глобальные стили
│   │   │   │   │   ├── layout.tsx  # Корневой layout
│   │   │   │   │   └── page.tsx    # Главная страница
│   │   │   ├── components/  # React компоненты
│   │   │   │   ├── auth/     # Компоненты аутентификации
│   │   │   │   ├── dashboard/ # Компоненты для дашборда
│   │   │   │   ├── layout/    # Компоненты лейаута
│   │   │   │   ├── marketing/ # Компоненты для лендинга
│   │   │   │   └── ui/        # UI компоненты (shadcn/ui)
│   │   │   ├── lib/         # Библиотеки и утилиты
│   │   │   ├── server/      # Server-only код
│   │   │   ├── trpc/        # tRPC конфигурация
│   │   │   └── utils/       # Вспомогательные функции
│   │   ├── next.config.mjs  # Next.js конфигурация
│   │   ├── package.json     # Зависимости приложения
│   │   └── tsconfig.json    # TypeScript конфигурация
│   ├── stripe/              # Stripe webhook handler (отдельное приложение)
│   └── ...
├── packages/                # Переиспользуемые пакеты
│   ├── auth/                # Аутентификация и авторизация
│   ├── common/              # Общие утилиты
│   ├── config/              # Конфигурации
│   ├── db/                  # База данных (Prisma схема)
│   ├── emails/              # Email шаблоны (React Email)
│   ├── ui/                  # UI компоненты
│   └── ...
├── tooling/                # Инструменты разработки
│   ├── eslint/             # ESLint конфигурация
│   ├── prettier/           # Prettier конфигурация
│   └── ...
├── turbo.json              # Turbo конфигурация
├── package.json            # Корневые зависимости
└── README.md               # Документация проекта
```

## 5. Модели данных

Основные модели данных, используемые в приложении:

- **User:**
    - `id` (PK)
    - `name`
    - `email` (unique)
    - `image`
    - `emailVerified`
    - Связи: Account, Session, Subscription
    
- **Account:**
    - `id` (PK)
    - `userId` (FK to User)
    - `provider` (e.g., "auth0")
    - `providerAccountId`
    - `type` (e.g., "oauth")
    - OAuth токены и данные
    
- **Session:**
    - `id` (PK)
    - `userId` (FK to User)
    - `expires`
    - `sessionToken`
    
- **Subscription:**
    - `id` (PK)
    - `userId` (FK to User)
    - `status` (active, canceled, etc.)
    - `planId`
    - `currentPeriodStart`
    - `currentPeriodEnd`
    - `cancelAtPeriodEnd`
    - Stripe метаданные
    
- **Customer:**
    - `id` (PK)
    - `userId` (FK to User)
    - `stripeCustomerId`
    - Billing информация
    
- **Product:**
    - `id` (PK)
    - `name`
    - `description`
    - `image`
    - `active`
    - `metadata`
    
- **Price:**
    - `id` (PK)
    - `productId` (FK to Product)
    - `type` (one_time, recurring)
    - `currency`
    - `amount`
    - `interval` (month, year, null)
    - `active`

## 6. Ключевые реализации

### Аутентификация и авторизация

- NextAuth.js с Auth0 провайдером для OAuth
- JWT для управления сессиями
- Middleware для защиты роутов
- Адаптер Kysely для хранения пользователей в базе данных
- Верификация email через Magic Links


### API с tRPC

- Типобезопасные API endpoints с tRPC
- Интеграция с React Query для клиентского кэширования
- Защищенные процедуры с middleware для авторизации


### Интеграция Stripe

- Stripe Checkout для обработки платежей
- Webhook handler для обработки событий
- Синхронизация подписок с базой данных


### Email-коммуникации

- React-email для создания типобезопасных шаблонов email
- Resend API для отправки писем
- Триггеры для различных событий (регистрация, смена пароля, и т.д.)


## 7. Нефункциональные требования

- **Производительность:** 
  - Core Web Vitals в зеленой зоне
  - Оптимизация размера бандла
  - Кэширование и ранняя загрузка данных
  - Оптимизация изображений
  
- **Безопасность:**
  - HTTPS для всех запросов
  - Защита от CSRF
  - Проверки на XSS
  - Rate limiting для API
  - Регулярные обновления зависимостей
  
- **Масштабируемость:**
  - Горизонтальное масштабирование сервисов
  - Connection pooling для базы данных
  - Кэширование запросов
  
- **Доступность (a11y):**
  - Соответствие WCAG 2.1 AA
  - Семантическая разметка
  - Поддержка клавиатурной навигации
  - Подходящий контраст цветов
  
- **Интернационализация (i18n):**
  - Полная поддержка множества языков
  - RTL поддержка для соответствующих языков
  - Локализованные даты, числа и валюты

## 8. Команды разработки

```bash
# Установка зависимостей
bun install

# Запуск dev сервера
bun dev

# Запуск dev сервера только для web
bun dev:web

# Сборка проекта
bun build

# Линтинг
bun lint

# Исправление линтинг-ошибок
bun lint:fix

# Форматирование кода
bun format

# Проверка типов
bun typecheck

# Запуск миграций базы данных
bun db:push

# Генерация нового компонента или пакета
bun gen
```


## 10. CI/CD и инфраструктура

- **GitHub Actions** для CI/CD
- **docker-compose** для хостинга на своем сервере
- **PostgreSQL** на облачном провайдере
- **Monitoring & Logging:**
  - Sentry для отслеживания ошибок
  - Vercel Analytics для производительности
  - Логирование через структурированные логи

## 11. Тестирование

- **Unit-тесты:** Vitest
- **Компонентное тестирование:** Testing Library
- **UI-тесты:** Storybook
- **E2E-тесты:** Playwright
- **Тестовые данные:** Faker.js, test-utils


## 12. Установка и обновление компонентов shadcn/ui

Установка компонентов через CLI:

```bash
# Установка нового компонента
npx shadcn-ui@latest add <component-name>

# Пример установки компонента button
npx shadcn-ui@latest add button --overwrite
```

## 13. Лучшие практики

### React

- Использование Server Components для статического контента
- Client Components только для интерактивных элементов
- Правильное использование хуков (useCallback, useMemo)
- Мемоизация при необходимости
- Правильная работа с формами через библиотеки (react-hook-form, zod)

### TypeScript

- Строгая типизация (strict mode)
- Интерфейсы/типы для всех данных
- Generic типы для переиспользуемых компонентов
- Использование enums для статических опций
- Строгие проверки null/undefined

### Безопасность

- Валидация всех пользовательских входных данных
- Использование CSRF-токенов
- Шифрование чувствительных данных
- Правильная обработка ошибок
- Безопасные заголовки HTTP
- Регулярное обновление зависимостей

### Производительность

- Lazy loading компонентов и роутов
- Оптимизация изображений
- Правильное использование кэширования
- Server-side рендеринг для SEO-страниц
- Минимизация количества клиентского JavaScript
